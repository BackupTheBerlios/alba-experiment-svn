#!/usr/bin/bash 

. /sbin/functions.sh

if [ -f /etc/make.conf ]; then
	. /etc/make.conf
else
	eerror "/etc/make.conf not found"
	exit 1
fi
if [ -f /etc/conf.d/alba-experiment-devtools.conf ]; then
	. /etc/conf.d/alba-experiment-devtools.conf
else
	eerror "/etc/conf.d/gentoolkit-dev-sunos.conf not found"
	exit 1
fi
EBUILD=$1
if [ -z "$EBUILD" ]; then
	eerror "Please specify an ebuild name to copy in '$AEOVERLAY'"
	exit 1
fi
if [ -z "$2" ]; then
	PORTDIR=/usr/portage
else
	PORTDIR=$2
fi

ADDKEYWORD='~x86-sunos'
PATCHBASEDIR="$AEOVERLAY/patches"

CATEGORY=`echo $EBUILD| sed s/-[0-9].*$//`
EBNAME=`echo $EBUILD | cut -d '/' -f 2`
EBFULLNAME=$PORTDIR/$CATEGORY/$EBNAME.ebuild
EBSHORTNAME=`echo $EBNAME | sed s/-[0-9].*$//`
EBVER=`echo $EBNAME | sed s/^$EBSHORTNAME//`
#echo EBVER $EBVER
EBVER_MAJ=`echo $EBVER | sed s/-r[0-9].*$//`
#echo EBVER_MAJ $EBVER_MAJ
EBVER_MIN=`echo $EBVER | sed s/^$EBVER_MAJ//`
#echo EBVER_MIN $EBVER_MIN
EBVER_REV=`echo $EBVER | sed s/^$EBVER_MAJ$EBVER_MIN//`
#echo EBVER_REV $EBVER_REV
EBNEWNAME=$EBNAME
#EBNEWNAME=${EBSHORTNAME}${EBVER_MAJ}-r1100
#einfon "Finding suitable revision number for $EBSHORTNAME..."
#rev=$EBVER_REV
#while [ -f $AEOVERLAY/$CATEGORY/$EBNEWNAME.ebuild ]; do
	#(( rev++ ))
	#EBNEWNAME=${EBSHORTNAME}${EBVER_MAJ}-r$rev
#done
#cho "$rev"
einfo "New ebuild name is: $EBNEWNAME"

if [ -f $EBFULLNAME ]; then
	ebegin "Copying ebuild to sunos portage tree: $AEOVERLAY"
	#ls -l $EBFULLNAME
	mkdir -p $AEOVERLAY/$CATEGORY > /dev/null 2>&1
	#echo "'$EBFULLNAME' => '$PORTDIR_OVERLAY/$CATEGORY/$EBNEWNAME.ebuild'"
	sed "/KEYWORDS=/ {
	s/\"$/ $ADDKEYWORD\"/
	}
	" $EBFULLNAME > $AEOVERLAY/$CATEGORY/$EBNEWNAME.ebuild
	gcp -Rf $PORTDIR/$CATEGORY/files $AEOVERLAY/$CATEGORY
	eend $?
	ebegin "Removing old digest"
	rm $AEOVERLAY/$CATEGORY/files/digest-* >/dev/null 2>&1
	eend $?
	ebegin "Downloading source and computing new digest"
	ebuild $AEOVERLAY/$CATEGORY/$EBNEWNAME.ebuild digest > /dev/null 2>&1
	eend $?
else
	eerror "No such ebuild found"
	exit 3
fi
if [ ! -z ${USESVN} ]; then
	ebegin "Adding initial ebuild to portage SVN tree"
	svn add $AEOVERLAY/$CATEGORY > /dev/null 2>&1
	svn commit $AEOVERLAY/$CATEGORY -m "initial ebuild addition for $CATEGORY" > /dev/null 2>&1
	eend $?
fi

#Diagnose ebuild
if grep gen_usr_ldscript $AEOVERLAY/$CATEGORY/$EBNEWNAME.ebuild ; then
	ewarn 
	ewarn "NOTE: The ebuild uses gen_usr_ldscript. You have to remove it if you are using sun-ld"
fi

if grep $CATEGORY $PATCHBASEDIR/patched-ebuilds; then
	ewarn
	ewarn "NOTE: this ebuild has been patched to work with x86-sunos"
	ewarn "      check in $PATCHBASEDIR/$CATEGORY for diff file"
fi

einfo "Testing the ebuild dependecies"
emerge -av =${CATEGORY}${EBVER}
